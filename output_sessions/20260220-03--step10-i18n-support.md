---
type: coding
exported_at: 2026-02-20T18:22:02
tools_used: [i18n, tkinter, copilot-sdk]
outcome_status: success
---

# Step10: Azure Ops Dashboard — 日本語/英語 i18n 対応

## Summary

Azure Ops Dashboard の全 UI テキスト・ログメッセージ・AI レポート出力を日本語/英語で切り替え可能にする i18n モジュールを新規作成し、main.py / ai_reviewer.py / collector.py に統合した。

## Timeline

### Phase 1 - i18n モジュール設計・作成

- `i18n.py` を新規作成（150+ 翻訳キー、`ja`/`en` 辞書）
- `t(key, **kwargs)` で翻訳取得、`set_language()` / `get_language()` でランタイム切替
- `on_language_changed()` コールバック登録機構
- フォーマット引数対応（例: `t("log.resources_found", count=42)` → `→ 42 件のリソースを取得`）
- Modified: [i18n.py](step10-azure-env-diagrammer/i18n.py)

### Phase 2 - main.py UI 文字列の i18n 化

- フォーム先頭に Language ラジオボタン（日本語 / English）を追加
- Row 番号を 0→Language, 1→View, 2→Sub, 3→RG, 4→MaxNodes, 5→OutputDir, 6→OpenWith に再配置
- 全ラベル・ヒント・ボタン・ステータス・ダイアログタイトルを `t()` に置換
- `_on_language_changed()` → `set_language()` → `_refresh_ui_texts()` で即時反映
- `_refresh_ui_texts()`: 全 widget の `.configure(text=...)` を一括更新
- `_VIEW_DESCRIPTIONS` dict → `_VIEW_DESC_KEYS` + `t()` 呼び出しに変更
- `(全サブスクリプション)` / `(全体)` 等の動的文字列も `t()` 経由に
- `_on_save_template` 内の局所変数名 `t` が翻訳関数 `t()` と衝突 → `tmpl` にリネーム
- Modified: [main.py](step10-azure-env-diagrammer/main.py)

### Phase 3 - AI プロンプト言語切替

- `ai_reviewer.py` の `generate()` メソッドで system prompt 末尾に `t("ai.output_language")` を自動付加
- `review()` / `run_security_report()` / `run_cost_report()` のユーザー prompt を `get_language()` で日英分岐
- Modified: [ai_reviewer.py](step10-azure-env-diagrammer/ai_reviewer.py)

### Phase 4 - collector.py preflight メッセージ対応

- `preflight_check()` の警告メッセージ（未ログイン / 拡張未インストール）を `get_language()` で日英切替
- `_classify_az_error()` のエラーメッセージも同様に対応
- Modified: [collector.py](step10-azure-env-diagrammer/collector.py)

### Phase 5 - README 更新

- i18n 対応の記載を冒頭 + GUI機能セクションに追加
- 使い方手順に Language 選択ステップを追加
- ファイル構成テーブルに `i18n.py`、`app_paths.py`、`docs_enricher.py` を追加
- テンプレート配置パスを OS 別テーブルに変更
- Modified: [README.md](step10-azure-env-diagrammer/README.md)

## Key Learnings

- `_on_save_template` 内で局所変数 `t = self._get_current_template_with_overrides()` としていたため、モジュールレベルの翻訳関数 `t()` がシャドウされて呼べなくなった。変数名を `tmpl` にリネームして解消。名前衝突に注意（L1 類似）
- tkinter の widget テキスト更新は `.configure(text=...)` で即時反映可能。ただし `ttk.Combobox` の `values` や `Radiobutton` のラベルは再生成が必要な場合がある
- AI system prompt に言語指示を追加する方式は、prompt 本文を複雑にせずに出力言語を制御でき、メンテナンスしやすい

## Commands & Code

```python
# i18n の基本使用パターン
from i18n import t, set_language, get_language

# 翻訳取得（フォーマット引数付き）
label = t("log.resources_found", count=42)
# ja: "  → 42 件のリソースを取得"
# en: "  → Fetched 42 resource(s)"

# 言語切替
set_language("en")

# AI プロンプトへの言語指示注入
system_prompt += "\n\n" + t("ai.output_language") + "\n"
# ja: "日本語の Markdown 形式で出力してください。"
# en: "Output in English Markdown format."
```

```python
# tkinter widget の即時テキスト更新
def _refresh_ui_texts(self) -> None:
    self._title_label.configure(text=t("app.title"))
    self._collect_btn.configure(text=t("btn.collect"))
    self._on_view_changed()  # View依存のラベルも再トリガ
```

## Next Steps

- [ ] 言語設定の永続化（`settings.json` or `%APPDATA%` に保存し、次回起動時に復元）
- [ ] i18n キーの網羅性テスト（未使用キー検出 / 翻訳漏れチェック）
- [ ] 3言語目（中国語等）追加時の拡張性検証
- [ ] exe 再ビルド + 言語切替の動作確認
